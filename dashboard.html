<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cafe Byte & Brew - Dashboard</title>
    <link rel="stylesheet" href="./stylesheet/style.css" />
    <script>
      // 拽  砖转砖 专
      const status = localStorage.getItem("status");

      //   砖转砖 砖专 专 -> 专拽 转 专 
      if (!status) {
        window.location.href = "index.html"; //  login.html   砖转 转 砖
      }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>
    <main class="dashboard-container">
      <section class="card greeting-card">
        <div class="greeting-text">
          <div>
            <h2 id="greetingMsg"></h2>
          </div>
          <p id="currentDate">Loading date...</p>
        </div>
      </section>

      <a href="categories.html" class="card menu-link-card">
        <img
          src="https://images.unsplash.com/photo-1495474472287-4d71bcdd2085?q=80&w=800&auto=format&fit=crop"
          alt="Coffee Menu"
        />
        <div class="menu-overlay">
          <span>View Menu</span>
        </div>
      </a>

      <a href="./memberCard.html" class="card club-card">
        <div class="card-icon"></div>
        <div>
          <h3>My Coffee Credit</h3>
          <div class="balance" id="dashBalance"></div>
          <small>Tap to load funds</small>
        </div>
      </a>

      <a href="./myOrders.html" class="card orders-card">
        <div class="card-header">
          <h3>My Recent Orders</h3>
        </div>
        <ul class="latest-orders" id="latestOrders"></ul>
      </a>

      <section class="card stats-card">
        <h3>Consumption Stats</h3>
        <div class="chart-container">
          <canvas id="myChart"></canvas>
        </div>
      </section>
    </main>
  </body>
</html>

<script type="module" src="./navbar/navbar.js"></script>
<script type="module">
  import { getSortedOrders, currentMonthOrders } from "./utilities/utils.js"; //  驻拽爪 砖

  document.addEventListener("DOMContentLoaded", () => {
    let userName = localStorage.getItem("user").split("@")[0] || "Guest";
    console.log(userName);

    // --- 1. Greeting & Time Logic ---
    const greetingEl = document.getElementById("greetingMsg");
    const dateEl = document.getElementById("currentDate");
    // Set Date
    const now = new Date();
    const options = {
      weekday: "long",
      year: "numeric",
      month: "long",
      day: "numeric",
      hour: "2-digit",
      minute: "2-digit",
    };
    dateEl.textContent = now.toLocaleDateString("he-IL", options);

    // Set Greeting based on hour
    const hour = now.getHours();
    let timeGreeting = "Good Morning";
    if (hour >= 12 && hour <= 18) timeGreeting = "Good Afternoon";
    else if (hour > 18) timeGreeting = "Good Evening";

    // Get User Name (Optional feature from PDF)
    greetingEl.textContent = `${timeGreeting}, ${userName}!`;

    // --- 2. Load Credit Balance ---
    const balanceEl = document.getElementById("dashBalance");
    const balance = parseFloat(localStorage.getItem("memberCardBalance")) || 0;
    balanceEl.textContent = `$${balance.toFixed(2)}`;

    // --- 3. Mini Order List (Last 3 items) ---
    const orderListEl = document.getElementById("latestOrders");
    const allOrders = getSortedOrders();

    if (!allOrders || !allOrders.length) {
      document.querySelector(".chart-container")?.remove();
      const latestLink = document.querySelector(".orders-card");
      latestLink.href = "#";
      const latestList = document.querySelector(".latest-orders");
      const statusCard = document.querySelector(".stats-card");

      const notFoundli = document.createElement("span");
      notFoundli.textContent = "No recent orders found.";
      const notFoundChart = document.createElement("span");
      notFoundChart.className = "not-found-chart";
      notFoundChart.textContent = "No recent orders found.";

      latestList.appendChild(notFoundli);
      statusCard.appendChild(notFoundChart);
    } else {
      //show the orders we have this month
      const countOrdersMonth = currentMonthOrders(allOrders);
      console.log(countOrdersMonth);

      const ordersThisMonth = document.createElement("p");
      ordersThisMonth.className = "current-month-orders";
      ordersThisMonth.textContent = `Your orders this month: ${countOrdersMonth}`;
      greetingEl.insertAdjacentElement("afterend", ordersThisMonth);

      // Take last 3 orders (assuming new ones are added at the end)
      const recentOrders = allOrders.slice(0, 3);

      recentOrders.forEach((order) => {
        const li = document.createElement("li");
        const ordName = document.createElement("span");
        const ordDate = document.createElement("span");
        const ordPrice = document.createElement("span");

        ordName.textContent = order.ProductName;
        ordDate.textContent = order.Date;
        ordPrice.textContent = parseFloat(order.Amount).toFixed(2) + "$";

        const infoDiv = document.createElement("div");
        infoDiv.classList = "latest-order-info";
        infoDiv.appendChild(ordDate);
        infoDiv.appendChild(ordPrice);

        li.appendChild(ordName);
        li.appendChild(infoDiv);

        orderListEl.appendChild(li);
      });

      // --- 4. Render Chart (Chart.js) ---
      const ctx = document.getElementById("myChart").getContext("2d");

      const productCounts = {};

      allOrders.forEach((order) => {
        const name = order.ProductName;
        productCounts[name] = (productCounts[name] || 0) + 1;
      });

      // Prepare data arrays for Chart.js
      const labels = Object.keys(productCounts); // e.g., ["Latte", "Bagel"]
      const dataPoints = Object.values(productCounts); // e.g., [5, 2]

      new Chart(ctx, {
        type: "bar",
        data: {
          labels: labels.length ? labels : ["No Data"], // Fallback if empty
          datasets: [
            {
              label: "Items Purchased",
              data: dataPoints.length ? dataPoints : [0],
              backgroundColor: "rgba(111, 78, 55, 0.6)", // Coffee color
              borderColor: "rgba(111, 78, 55, 1)",
              borderWidth: 1,
              borderRadius: 4,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: { beginAtZero: true, ticks: { stepSize: 1 } },
            x: { grid: { display: false } },
          },
          plugins: {
            legend: { display: false },
          },
        },
      });
    }
  });
</script>
