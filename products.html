<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title></title>
    <link rel="stylesheet" href="./stylesheet/style.css" />
  </head>
  <body>
    <div class="page-title"><h1></h1></div>
  </body>
</html>

<script type="module" src="./navbar/navbar.js"></script>
<script type="module">
  import { getCurrentDate } from "./utilities/utils.js"; // ייבוא הפונקציה

  const params = new URLSearchParams(window.location.search);
  const categoryId = params.get("category");
  const categoryName = params.get("name");
  document.title = categoryName;
  document.querySelector(".page-title h1").innerText = categoryName;

  const products = JSON.parse(localStorage.getItem("products")) || [];
  console.log(products);

  const pageTitle = document.querySelector(".page-title");

  if (!products || !products.length) {
    const notFound = document.createElement("div");
    notFound.className = "not-found";
    const nTxt = document.createElement("h2");
    nTxt.textContent = "Not found...";
    notFound.appendChild(nTxt);
    pageTitle.insertAdjacentElement("afterend", notFound);
  } else {
    const productsContainer = document.createElement("div");
    productsContainer.className = "products-grid";

    const filteredProducts = products.filter(
      (product) => product.CategoryId.toString() === categoryId
    );

    filteredProducts.forEach((product, index) => {
      const productCard = document.createElement("div");
      productCard.className = "product-card";

      // 1. Create Image
      const img = document.createElement("img");
      // Note: Make sure this path logic matches your actual file structure
      img.src = product.ImageUrl;
      img.className = "product-img"; // Added class for styling
      img.alt = product.ProductName; // Good for accessibility
      productCard.appendChild(img);

      // 2. Create Content Wrapper (for padding)
      const infoDiv = document.createElement("div");
      infoDiv.className = "card-info";

      const name = document.createElement("h3");
      name.textContent = product.ProductName;
      infoDiv.appendChild(name);

      const priceText = document.createElement("p");
      priceText.className = "price-tag";

      const price = parseFloat(product.Price).toFixed(2);
      priceText.textContent = `$${price}`;
      infoDiv.appendChild(priceText);

      const purchaseBtn = document.createElement("button");
      purchaseBtn.textContent = "purchase";
      purchaseBtn.id = `purchaseBtn-${index}`;

      purchaseBtn.addEventListener("click", () => {
        try {
          let currentBalance =
            parseFloat(localStorage.getItem("memberCardBalance")) || 0;

          if (currentBalance < price) {
            alert(
              `Can not purchase ${product.ProductName} due to insufficient funds`
            );
            return;
          }

          const orders = JSON.parse(localStorage.getItem("orders")) || [];
          const dateStr = getCurrentDate();
          orders.push({
            Date: dateStr,
            category: product.CategoryId,
            ProductName: product.ProductName,
            Amount: product.Price,
          });
          currentBalance = currentBalance - price;
          localStorage.setItem("orders", JSON.stringify(orders));
          localStorage.setItem("memberCardBalance", currentBalance);
          alert(
            `Purchased: ${product.ProductName} for $${parseFloat(
              product.Price
            ).toFixed(2)}`
          );
        } catch (e) {
          alert("Error processing purchase. See console for details.");
          console.error("Error processing purchase:", e);
        }
      });
      infoDiv.appendChild(purchaseBtn);

      // Append info to card, and card to container
      productCard.appendChild(infoDiv);
      productsContainer.appendChild(productCard);
      pageTitle.insertAdjacentElement("afterend", productsContainer);
    });
  }
</script>

<style>
  .page-title {
    margin-top: 50px;
    margin-bottom: 10px;
  }
</style>
